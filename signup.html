<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إنشاء حساب</title>

<style>
body{
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  background:linear-gradient(-45deg,#0f2027,#203a43,#2c5364,#0f2027);
  background-size:400% 400%;
  animation:gradientMove 12s ease infinite;
  font-family:Tahoma;
  color:#fff;
}
@keyframes gradientMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
h1{
  margin-bottom:20px;
  text-shadow:0 0 15px #00e6ff;
}
form{
  width:320px;
  display:flex;
  flex-direction:column;
}
input,select,button{
  margin:8px 0;
  padding:12px;
  border-radius:20px;
  border:2px solid #00e6ff;
  background:rgba(0,0,0,.2);
  color:#fff;
  font-size:1rem;
  outline:none;
}
button{
  background:#00e6ff;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
button:hover{
  box-shadow:0 0 15px #00e6ff;
}
.error{
  color:#ff4d4d;
  font-size:.9rem;
}
</style>
</head>

<body>

<h1>إنشاء حساب جديد</h1>

<form id="signupForm">
  <input id="username" placeholder="اسم المستخدم" required>
  <input id="email" type="email" placeholder="البريد الإلكتروني" required>
  <input id="password" type="password" placeholder="كلمة المرور" required>
  <input id="confirm" type="password" placeholder="تأكيد كلمة المرور" required>

  <!-- العمر (قائمة) -->
  <select id="ageGroup" required>
    <option value="">اختر الفئة العمرية</option>
    <option value="10-18">10 – 18</option>
    <option value="19-25">19 – 25</option>
    <option value="25-30">25 – 30</option>
    <option value="30-40">30 – 40</option>
    <option value="40+">40+</option>
  </select>

  <!-- IBAN -->
  <input id="iban" placeholder="SAxxxxxxxxxxxxxxxxx" required>

  <div id="error" class="error"></div>
  <button>إنشاء الحساب</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-hbThdD4r_3V5L0ZC-Jqd5VW5VmvjrJE",
  authDomain: "salh-2e2e7.firebaseapp.com",
  projectId: "salh-2e2e7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const form = document.getElementById("signupForm");
const errorDiv = document.getElementById("error");
const ibanInput = document.getElementById("iban");

/* تثبيت SA + 17 رقم */
ibanInput.value = "SA";
ibanInput.addEventListener("input", () => {
  ibanInput.value = "SA" + ibanInput.value.replace(/[^0-9]/g,"").slice(0,17);
});

form.onsubmit = async e => {
  e.preventDefault();
  errorDiv.textContent = "";

  const username = username.value.trim();
  const email = email.value.trim();
  const pass = password.value;
  const confirmPass = confirm.value;
  const ageGroup = ageGroup.value;
  const iban = ibanInput.value;

  if(pass.length < 6)
    return errorDiv.textContent="كلمة المرور يجب أن تكون 6 أحرف على الأقل";

  if(pass !== confirmPass)
    return errorDiv.textContent="كلمتا المرور غير متطابقتين";

  if(iban.length !== 19)
    return errorDiv.textContent="رقم الآيبان غير مكتمل";

  try{
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{ displayName: username });

    await setDoc(doc(db,"users",cred.user.uid),{
      displayName: username,
      email,
      ageGroup,
      iban,
      balance: 0,
      role: "user",
      createdAt: Date.now()
    });

    /* انتقال مباشر للصفحة الرئيسية */
    location.href = "index.html";

  }catch(err){
    errorDiv.textContent = err.message;
  }
};
</script>

</body>
</html>
