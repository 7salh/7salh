<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إنشاء حساب / تسجيل الدخول</title>

<style>
body{
  margin:0;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(-45deg,#0f2027,#203a43,#2c5364,#0f2027);
  background-size:400% 400%;
  animation:move 12s ease infinite;
  font-family:Tahoma;
  color:#fff;
}
@keyframes move{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
form{
  width:320px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
h1{text-align:center}
input,select,button{
  padding:12px;
  border-radius:20px;
  border:2px solid #00e6ff;
  background:rgba(0,0,0,.2);
  color:#fff;
  font-size:1rem;
}
button{
  background:#00e6ff;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
.error{
  color:#ff4d4d;
  font-size:.9rem;
}
.hidden{display:none}
</style>
</head>

<body>

<!-- ===== إنشاء الحساب ===== -->
<form id="signupSection">
  <h1>إنشاء حساب جديد</h1>

  <input id="username" placeholder="اسم المستخدم" required>
  <input id="email" type="email" placeholder="البريد الإلكتروني" required>
  <input id="password" type="password" placeholder="كلمة المرور" required>
  <input id="confirm" type="password" placeholder="تأكيد كلمة المرور" required>

  <select id="ageGroup" required>
    <option value="">اختر الفئة العمرية</option>
    <option value="10-18">10 - 18</option>
    <option value="19-25">19 - 25</option>
    <option value="25-30">25 - 30</option>
    <option value="30-40">30 - 40</option>
    <option value="40+">40+</option>
  </select>

  <input id="iban" placeholder="SAxxxxxxxxxxxxxxxxx" required>

  <div id="signupError" class="error"></div>
  <button type="submit">تم</button>
</form>

<!-- ===== تسجيل الدخول ===== -->
<form id="loginSection" class="hidden">
  <h1>تسجيل الدخول</h1>

  <input id="identifier" placeholder="البريد الإلكتروني أو اسم المستخدم" required>
  <input id="loginPassword" type="password" placeholder="كلمة المرور" required>
  <div id="loginError" class="error"></div>
  <button type="submit">تسجيل الدخول</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-hbThdD4r_3V5L0ZC-Jqd5VW5VmvjrJE",
  authDomain: "salh-2e2e7.firebaseapp.com",
  projectId: "salh-2e2e7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== إنشاء الحساب ===== */
iban.value = "SA";
iban.oninput = () => {
  iban.value = "SA" + iban.value.replace(/[^0-9]/g,"").slice(0,17);
};

signupSection.onsubmit = async e => {
  e.preventDefault();
  signupError.textContent = "";

  if(password.value.length < 6)
    return signupError.textContent = "كلمة المرور قصيرة";

  if(password.value !== confirm.value)
    return signupError.textContent = "كلمتا المرور غير متطابقتين";

  try{
    const cred = await createUserWithEmailAndPassword(auth, email.value, password.value);

    await setDoc(doc(db,"users",cred.user.uid),{
      displayName: username.value,
      email: email.value,
      ageGroup: ageGroup.value,
      iban: iban.value,
      balance:0,
      role:"user",
      createdAt:Date.now()
    });

    signupSection.classList.add("hidden");
    loginSection.classList.remove("hidden");

  }catch(err){
    signupError.textContent = "خطأ في إنشاء الحساب";
  }
};

/* ===== تسجيل الدخول ===== */
loginSection.onsubmit = async e => {
  e.preventDefault();
  loginError.textContent = "";

  let id = identifier.value.trim();
  const pass = loginPassword.value;

  try{
    if(!id.includes("@")){
      const q = query(collection(db,"users"), where("displayName","==",id));
      const snap = await getDocs(q);
      if(snap.empty) throw new Error("اسم المستخدم غير موجود");
      id = snap.docs[0].data().email;
    }

    await signInWithEmailAndPassword(auth,id,pass);
    location.href="index.html";
  }catch(err){
    loginError.textContent = err.message;
  }
};
</script>

</body>
</html>
