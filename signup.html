<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إنشاء حساب</title>

<style>
body{
  margin:0;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(-45deg,#0f2027,#203a43,#2c5364,#0f2027);
  background-size:400% 400%;
  animation:move 12s ease infinite;
  font-family:Tahoma;
  color:#fff;
}
@keyframes move{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
form{
  width:320px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
h1{text-align:center}
input,select,button{
  padding:12px;
  border-radius:20px;
  border:2px solid #00e6ff;
  background:rgba(0,0,0,.2);
  color:#fff;
  font-size:1rem;
}
button{
  background:#00e6ff;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
.error{
  color:#ff4d4d;
  font-size:.9rem;
}
</style>
</head>

<body>

<form id="signupForm">
  <h1>إنشاء حساب جديد</h1>

  <input id="username" placeholder="اسم المستخدم" required>
  <input id="email" type="email" placeholder="البريد الإلكتروني" required>
  <input id="password" type="password" placeholder="كلمة المرور" required>
  <input id="confirm" type="password" placeholder="تأكيد كلمة المرور" required>

  <select id="ageGroup" required>
    <option value="">اختر الفئة العمرية</option>
    <option value="10-18">10 - 18</option>
    <option value="19-25">19 - 25</option>
    <option value="25-30">25 - 30</option>
    <option value="30-40">30 - 40</option>
    <option value="40+">40+</option>
  </select>

  <input id="iban" placeholder="SAxxxxxxxxxxxxxxxxx" required>

  <div id="error" class="error"></div>
  <button type="submit">إنشاء الحساب</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-hbThdD4r_3V5L0ZC-Jqd5VW5VmvjrJE",
  authDomain: "salh-2e2e7.firebaseapp.com",
  projectId: "salh-2e2e7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const form = document.getElementById("signupForm");
const errorDiv = document.getElementById("error");

const usernameInput = document.getElementById("username");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const confirmInput = document.getElementById("confirm");
const ageGroupSelect = document.getElementById("ageGroup");
const ibanInput = document.getElementById("iban");

/* IBAN: SA + 17 رقم فقط */
ibanInput.value = "SA";
ibanInput.addEventListener("input", () => {
  ibanInput.value = "SA" + ibanInput.value.replace(/[^0-9]/g,"").slice(0,17);
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  errorDiv.textContent = "";

  const username = usernameInput.value.trim();
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  const confirm = confirmInput.value;
  const ageGroup = ageGroupSelect.value;
  const iban = ibanInput.value;

  // التحقق من صحة البيانات
  if(password.length < 6) {
    return errorDiv.textContent = "كلمة المرور يجب أن تكون 6 أحرف على الأقل";
  }

  if(password !== confirm) {
    return errorDiv.textContent = "كلمتا المرور غير متطابقتين";
  }

  if(iban.length !== 19) {
    return errorDiv.textContent = "رقم الآيبان غير صحيح";
  }

  try {
    // إنشاء الحساب
    const cred = await createUserWithEmailAndPassword(auth, email, password);

    // حفظ البيانات في Firestore
    await setDoc(doc(db, "users", cred.user.uid), {
      displayName: username,
      email,
      ageGroup,
      iban,
      balance: 0,
      role: "user",
      createdAt: Date.now()
    });

    console.log("تم إنشاء الحساب وحفظ البيانات بنجاح");

    // محاولة تسجيل الخروج بدون منع إعادة التوجيه
    try {
      await signOut(auth);
      console.log("تم تسجيل الخروج بنجاح");
    } catch (logoutErr) {
      console.warn("فشل تسجيل الخروج:", logoutErr.message);
    }

    // إعادة التوجيه دائمًا
    console.log("سيتم تحويلك إلى صفحة تسجيل الدخول الآن");
    location.replace("./login.html");

  } catch (err) {
    console.error("حدث خطأ أثناء إنشاء الحساب:", err);
    // عرض رسالة مختصرة للمستخدم
    if(err.code === "auth/email-already-in-use") {
      errorDiv.textContent = "هذا البريد الإلكتروني مستخدم بالفعل";
    } else {
      errorDiv.textContent = "حدث خطأ أثناء إنشاء الحساب، حاول مرة أخرى";
    }
  }
});
</script>

</body>
</html>
